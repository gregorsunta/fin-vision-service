services:
  api:
    build:
      context: .
      target: production
    command: node dist/api/index.js
    env_file: .env
    environment:
      - NODE_ENV=production
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - fin-vision-net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  worker:
    build:
      context: .
      target: production
    command: node dist/workers/index.js
    env_file: .env
    environment:
      - NODE_ENV=production
      - GOOGLE_APPLICATION_CREDENTIALS=/app/gcp-credentials.json
    volumes: # This volume is for credentials, not persistent data, so it stays
      - ./${GOOGLE_APPLICATION_CREDENTIALS:-gcp-credentials.json}:/app/gcp-credentials.json:ro
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - fin-vision-net

  mysql:
    image: mysql:8.4
    restart: always
    environment:
      MYSQL_DATABASE: ${DB_NAME:-fin_vision_db}
      MYSQL_USER: ${DB_USER:-user}
      MYSQL_PASSWORD: ${DB_PASSWORD:-password}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-rootpassword}
    networks:
      - fin-vision-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s # Give MySQL time to start before first check

  redis:
    image: redis:7-alpine
    restart: always
    networks:
      - fin-vision-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

networks:
  fin-vision-net: